<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan BPMP Papua Barat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        
        /* Glass Effect */
        .glass { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.5); 
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .bg-gradient-brand {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
        }

        /* Navigasi Halaman (Fix Layar Putih) */
        .app-page { display: none; animation: fadeIn 0.4s ease-out; }
        .app-page.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media print {
            body { background: white; }
            .no-print, #navbar, #toast { display: none !important; }
            #modal-preview { position: absolute; top: 0; left: 0; width: 100%; height: auto; z-index: 9999; background: white; overflow: visible; }
            .a4-paper { box-shadow: none; border: none; margin: 0; width: 100%; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-blue-200 selection:text-blue-900">

    <div id="toast" class="fixed top-6 right-6 hidden z-[100] transform transition-all duration-300">
        <div class="glass px-6 py-4 rounded-2xl shadow-2xl border-l-4 flex items-center gap-3 font-semibold text-sm">
            <span id="toast-icon"></span>
            <span id="toast-msg">Notifikasi</span>
        </div>
    </div>

    <div id="page-login" class="app-page active">
        <div class="min-h-screen flex items-center justify-center bg-gradient-brand relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden opacity-20 pointer-events-none">
                <div class="absolute -top-[20%] -left-[10%] w-[600px] h-[600px] rounded-full bg-white blur-3xl"></div>
                <div class="absolute bottom-[10%] right-[10%] w-[400px] h-[400px] rounded-full bg-blue-400 blur-3xl"></div>
            </div>

            <div class="glass p-10 rounded-3xl shadow-2xl w-full max-w-md m-4 relative z-10">
                <div class="text-center mb-10">
                    <div class="inline-flex p-4 rounded-2xl bg-blue-50/50 mb-6 shadow-inner ring-1 ring-white/60">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg" alt="Logo Tut Wuri" class="w-16 h-16 object-contain drop-shadow-md">
                    </div>
                    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">SIGANAS</h1>
                    <p class="text-slate-500 text-sm mt-2 font-medium">Sistem Pelaporan Kegiatan Dinas</p>
                    <div class="mt-2 inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold uppercase tracking-wider">BPMP Papua Barat</div>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div class="group">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1 tracking-wide">Username</label>
                        <input type="text" id="login-user" placeholder="NIP / Username" class="w-full px-5 py-3.5 rounded-xl border border-slate-200 bg-white/70 focus:bg-white focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition duration-200 font-medium placeholder:text-slate-400" required>
                    </div>
                    <div class="group">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1 tracking-wide">Password</label>
                        <input type="password" id="login-pass" placeholder="••••••••" class="w-full px-5 py-3.5 rounded-xl border border-slate-200 bg-white/70 focus:bg-white focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition duration-200 font-medium placeholder:text-slate-400" required>
                    </div>
                    
                    <button type="submit" id="btn-login" class="w-full py-4 bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-800 hover:to-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transform active:scale-[0.98] transition-all duration-200 mt-2">
                        Masuk Aplikasi
                    </button>
                    
                    <div class="text-center mt-6">
                        <a href="#" onclick="showResetModal()" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition">Lupa Password?</a>
                    </div>
                </form>
                
                <div class="mt-8 pt-6 border-t border-slate-200/60 text-center">
                    <p class="text-xs text-slate-400 font-medium">&copy; 2026 BPMP Provinsi Papua Barat</p>
                </div>
            </div>
        </div>
    </div>

    <nav id="navbar" class="hidden fixed top-0 w-full z-40 glass-nav transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 text-white p-2.5 rounded-xl shadow-lg shadow-blue-500/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <div class="leading-tight">
                        <span class="block text-lg font-bold text-slate-800 tracking-tight">SIGANAS</span>
                        <span class="block text-[10px] text-slate-500 font-bold uppercase tracking-wider">Dashboard Sistem</span>
                    </div>
                </div>

                <div class="hidden md:flex items-center gap-2 bg-slate-100/50 p-1.5 rounded-2xl border border-slate-200/60">
                    <button onclick="switchPage('page-input')" class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-blue-700 hover:bg-white hover:shadow-sm transition-all duration-200">Input Data</button>
                    <button id="menu-data" onclick="loadLaporan()" class="hidden px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-blue-700 hover:bg-white hover:shadow-sm transition-all duration-200">Data Laporan</button>
                    <button id="menu-user" onclick="loadUsers()" class="hidden px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-purple-700 hover:bg-white hover:shadow-sm transition-all duration-200">Kelola User</button>
                </div>

                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div id="nav-username" class="text-sm font-bold text-slate-800">User</div>
                        <div id="nav-role" class="text-[10px] font-extrabold text-blue-600 uppercase bg-blue-50 px-2 py-0.5 rounded-full inline-block">Role</div>
                    </div>
                    <div class="h-10 w-[1px] bg-slate-200 hidden sm:block"></div>
                    <button onclick="doLogout()" class="group flex items-center gap-2 pl-3 pr-4 py-2 bg-white border border-slate-200 text-slate-600 hover:text-red-600 hover:border-red-100 hover:bg-red-50 rounded-xl transition-all duration-200 font-bold text-sm shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg> Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="h-24"></div>

    <div id="page-input" class="app-page max-w-5xl mx-auto px-4 pb-20">
        <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div><h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Input Laporan</h2><p class="text-slate-500 mt-1">Silakan lengkapi form kegiatan di bawah ini.</p></div>
        </div>

        <form id="form-laporan" onsubmit="submitLaporan(event)" class="space-y-8">
            <div class="bg-white rounded-3xl p-8 shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-blue-600"></div>
                <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm">1</span> Detail Kegiatan</h3>
                <div class="space-y-6">
                    <div><label class="block text-sm font-bold text-slate-700 mb-2">Judul Laporan</label><input type="text" name="judul" required class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none font-medium" placeholder="Contoh: Rapat Koordinasi Wilayah..."></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-bold text-slate-700 mb-2">Tempat Pelaksanaan</label><input type="text" name="tempat" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none font-medium" required placeholder="Nama Hotel / Gedung"></div>
                        <div><label class="block text-sm font-bold text-slate-700 mb-2">Tanggal Kegiatan</label><input type="date" name="tanggal" id="input-date" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none font-medium" required></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-8 shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-purple-500"></div> 
                <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><span class="bg-purple-100 text-purple-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm">2</span> Isi Laporan</h3>
                <div class="grid grid-cols-1 gap-6">
                    <div><label class="block text-sm font-bold text-slate-700 mb-2">Pendahuluan</label><textarea name="pendahuluan" rows="3" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Latar belakang kegiatan..."></textarea></div>
                    <div><label class="block text-sm font-bold text-slate-700 mb-2">Pelaksanaan Kegiatan</label><textarea name="kegiatan" rows="4" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Rincian jalannya acara..."></textarea></div>
                    <div><label class="block text-sm font-bold text-slate-700 mb-2">Hasil Kegiatan</label><textarea name="hasil" rows="3" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Output yang dicapai..."></textarea></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-bold text-slate-700 mb-2">Simpulan</label><textarea name="simpulan" rows="3" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Kesimpulan..."></textarea></div>
                        <div><label class="block text-sm font-bold text-slate-700 mb-2">Saran</label><textarea name="saran" rows="3" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Saran..."></textarea></div>
                    </div>
                    <div><label class="block text-sm font-bold text-slate-700 mb-2">Penutup</label><textarea name="penutup" rows="2" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Penutup..."></textarea></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white rounded-3xl p-8 shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-emerald-500"></div>
                    <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><span class="bg-emerald-100 text-emerald-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm">3</span> Dokumentasi</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Foto 1</span></div><input type="file" accept="image/*" onchange="processImage(this, 0)" class="block w-full text-xs text-slate-500 mb-2"><input type="text" name="ket1" placeholder="Ket..." class="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-emerald-500/20 outline-none"></div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Foto 2</span></div><input type="file" accept="image/*" onchange="processImage(this, 1)" class="block w-full text-xs text-slate-500 mb-2"><input type="text" name="ket2" placeholder="Ket..." class="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-emerald-500/20 outline-none"></div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Foto 3</span></div><input type="file" accept="image/*" onchange="processImage(this, 2)" class="block w-full text-xs text-slate-500 mb-2"><input type="text" name="ket3" placeholder="Ket..." class="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-emerald-500/20 outline-none"></div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-slate-500 uppercase">Foto 4</span></div><input type="file" accept="image/*" onchange="processImage(this, 3)" class="block w-full text-xs text-slate-500 mb-2"><input type="text" name="ket4" placeholder="Ket..." class="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-emerald-500/20 outline-none"></div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-orange-500"></div>
                    <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><span class="bg-orange-100 text-orange-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm">4</span> Pelapor</h3>
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama ASN</label><input type="text" name="nama_asn" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all outline-none font-medium" placeholder="Nama Lengkap" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP</label><input type="number" name="nip" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all outline-none font-medium" placeholder="19xxxxxxxxxx" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jabatan</label><input type="text" name="jabatan" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all outline-none font-medium" placeholder="Jabatan" required></div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button type="submit" id="btn-submit-lap" class="flex-1 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold rounded-2xl shadow-xl shadow-blue-500/20 transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2 text-lg">Simpan Laporan</button>
                <button type="button" onclick="resetForm()" class="px-8 py-4 bg-white text-slate-600 font-bold rounded-2xl shadow-lg border border-slate-100 hover:bg-slate-50 hover:text-red-600 transition-all duration-200 flex items-center justify-center gap-2">Reset</button>
            </div>
            
            <div id="progress-container" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 glass px-6 py-4 rounded-full shadow-2xl z-50 border border-blue-100 flex items-center gap-4 w-[90%] max-w-md">
                <div class="flex-1"><div class="flex justify-between mb-1 text-xs font-bold text-blue-700"><span>Proses...</span><span id="progress-text">0%</span></div><div class="w-full bg-blue-100 rounded-full h-2"><div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div></div></div>
            </div>
        </form>
    </div>

    <div id="page-data" class="app-page max-w-7xl mx-auto px-4 pb-20">
        <div class="mb-8"><h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Data Laporan</h2></div>
        <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50/80 border-b border-slate-200">
                            <th class="p-5 text-xs font-extrabold text-slate-500 uppercase tracking-wider">Tanggal</th>
                            <th class="p-5 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-1/3">Judul</th>
                            <th class="p-5 text-xs font-extrabold text-slate-500 uppercase tracking-wider">Pembuat</th>
                            <th class="p-5 text-xs font-extrabold text-slate-500 uppercase tracking-wider text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
            <div id="loading-data" class="hidden p-12 text-center"><div class="inline-flex items-center justify-center p-4 bg-blue-50 rounded-full mb-3"><div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div></div><p class="text-slate-500 font-medium">Mengambil data...</p></div>
        </div>
    </div>

    <div id="page-users" class="app-page max-w-5xl mx-auto px-4 pb-20">
        <div class="mb-8"><h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Kelola Pengguna</h2></div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 sticky top-24">
                    <h3 class="font-bold text-slate-800 mb-4 pb-4 border-b border-slate-100">Tambah User</h3>
                    <form onsubmit="addUser(event)" class="space-y-4">
                        <div><input type="text" id="new-user" placeholder="Username" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none text-sm font-medium" required></div>
                        <div><input type="text" id="new-pass" placeholder="Password" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none text-sm font-medium" required></div>
                        <div><select id="new-role" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none text-sm font-medium"><option value="user">User Biasa</option><option value="verifikator">Verifikator</option><option value="admin">Admin</option></select></div>
                        <div><input type="email" id="new-email" placeholder="Email Aktif" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none text-sm font-medium" required></div>
                        <button type="submit" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg transition-all text-sm">Simpan User</button>
                    </form>
                </div>
            </div>
            <div class="lg:col-span-2">
                <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead><tr class="bg-purple-50/80 border-b border-purple-100"><th class="p-5 text-xs font-extrabold text-purple-800 uppercase">Username</th><th class="p-5 text-xs font-extrabold text-purple-800 uppercase">Role</th><th class="p-5 text-xs font-extrabold text-purple-800 uppercase">Email</th><th class="p-5 text-xs font-extrabold text-purple-800 uppercase">Aksi</th></tr></thead>
                        <tbody id="table-users" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-reset" class="fixed inset-0 bg-slate-900/60 hidden z-[100] flex items-center justify-center backdrop-blur-sm transition-all duration-300">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm m-4 relative">
            <button onclick="document.getElementById('modal-reset').classList.add('hidden')" class="absolute top-4 right-4 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-red-500 transition">X</button>
            <div class="text-center mb-6"><h3 class="text-xl font-bold text-slate-800">Reset Password</h3><p class="text-sm text-slate-500 mt-2">Masukkan Username Anda.</p></div>
            <form onsubmit="handleReset(event)" class="space-y-4"><input type="text" id="reset-user" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-blue-500 outline-none text-center font-bold" placeholder="Username" required><button type="submit" id="btn-reset" class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition">Kirim Password</button></form>
        </div>
    </div>

    <div id="modal-preview" class="fixed inset-0 bg-slate-900/80 hidden z-[9999] overflow-y-auto backdrop-blur-sm">
        <div class="min-h-screen py-10 flex justify-center px-4">
            <div class="relative w-full max-w-[210mm]">
                <div class="bg-slate-800 text-white p-4 rounded-xl flex justify-between items-center no-print sticky top-4 z-50 shadow-2xl mb-6">
                    <h3 class="font-bold text-sm md:text-base ml-2">Pratinjau Dokumen</h3>
                    <div class="flex gap-3"><button onclick="document.getElementById('modal-preview').classList.add('hidden')" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-sm transition">Tutup</button><button onclick="window.print()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 font-bold text-sm transition">Cetak / PDF</button></div>
                </div>
                <div id="doc-container">
                    <div class="a4-paper bg-white p-12 shadow-2xl mb-8 relative min-h-[297mm]">
                        <div class="w-full mb-8 border-b-[3px] border-black pb-4 flex items-center gap-6"><img src="" id="img-kop-preview" alt="Logo" class="w-24 h-24 object-contain"><div class="text-center flex-1"><h2 class="text-lg font-bold uppercase tracking-wide">Kementerian Pendidikan, Kebudayaan,<br>Riset, dan Teknologi</h2><h1 class="text-xl font-extrabold uppercase mt-1">Balai Penjaminan Mutu Pendidikan<br>Provinsi Papua Barat</h1><p class="text-xs mt-2 italic font-serif">Alamat: Jl. Brigjend Marinir (Purn) Abraham O. Atururi, Arfai, Manokwari</p></div></div>
                        <div class="text-center mb-10"><h2 class="font-bold text-xl uppercase underline decoration-2 underline-offset-4">LAPORAN KEGIATAN</h2><h3 id="p-judul" class="font-bold text-lg uppercase mt-4 px-8 leading-relaxed"></h3></div>
                        <div class="text-[11pt] text-black space-y-6 px-2 text-justify leading-relaxed font-serif">
                            <div><div class="font-bold uppercase mb-1">A. Pendahuluan</div><p id="p-pendahuluan" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">B. Pelaksanaan Kegiatan</div><p id="p-kegiatan" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">C. Hasil Kegiatan</div><p id="p-hasil" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">D. Simpulan</div><p id="p-simpulan" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">E. Saran / Rekomendasi</div><p id="p-saran" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">F. Penutup</div><p id="p-penutup" class="whitespace-pre-wrap ml-6"></p></div>
                        </div>
                        <div class="mt-20 flex justify-end px-8"><div class="text-center min-w-[250px] text-[11pt] text-black font-serif"><p id="p-tgl" class="mb-1"></p><p id="p-jabatan" class="font-bold mb-24"></p><p id="p-nama" class="font-bold underline uppercase"></p><p id="p-nip" class="mt-1 font-medium"></p></div></div>
                    </div>
                    <div id="doc-photos-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONST_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxWCLMEvv8OgkER-QPdaPZQclWdOlKisGfQWioC7ZnqE1itiTah7UfZ3gBREElpAsGVHQ/exec"; 
        
        let currentUser = null;
        let uploadedImages = [null, null, null, null];
        let isEditMode = false;
        let originalJudul = "";

        // --- FUNGSI GANTI HALAMAN (FIX LAYAR PUTIH) ---
        function switchPage(pageId) {
            // Sembunyikan semua halaman
            const pages = document.querySelectorAll('.app-page');
            pages.forEach(el => el.style.display = 'none');
            pages.forEach(el => el.classList.remove('active'));

            // Tampilkan halaman target
            const target = document.getElementById(pageId);
            if(target) {
                target.style.display = 'block';
                // Sedikit delay agar animasi jalan
                setTimeout(() => target.classList.add('active'), 10);
            }

            updateNavbar();
            if(pageId === 'page-data') loadLaporan();
            if(pageId === 'page-users') loadUsers();
            
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function updateNavbar() {
            const nav = document.getElementById('navbar');
            if (currentUser) {
                nav.classList.remove('hidden');
                document.getElementById('nav-username').innerText = currentUser.username;
                document.getElementById('nav-role').innerText = currentUser.role;
                document.getElementById('menu-data').classList.remove('hidden');
                document.getElementById('menu-user').classList.toggle('hidden', currentUser.role !== 'admin');
            } else { 
                nav.classList.add('hidden'); 
            }
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const txt = document.getElementById('toast-msg');
            
            t.className = `fixed top-6 right-6 z-[100] transform transition-all duration-300 translate-y-0 opacity-100`;
            
            if(type === 'error') {
                txt.parentElement.classList.add('border-red-500', 'text-red-700');
                icon.innerHTML = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else {
                txt.parentElement.classList.add('border-green-500', 'text-green-700');
                icon.innerHTML = `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }
            
            txt.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => t.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- Logic Utama ---
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-login'); 
            const u = document.getElementById('login-user').value; 
            const p = document.getElementById('login-pass').value;
            
            btn.disabled = true; 
            btn.innerHTML = `Memproses...`;
            
            try {
                const res = await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username: u, password: p }) });
                const json = await res.json();
                if(json.status === 'success') {
                    currentUser = { username: json.username, role: json.role };
                    localStorage.setItem('bpmp_user_session', JSON.stringify(currentUser));
                    showToast('Login Berhasil!', 'success');
                    switchPage('page-input');
                } else { showToast(json.message, 'error'); }
            } catch(err) { showToast('Gagal koneksi server', 'error'); } 
            finally { 
                btn.disabled = false; 
                btn.innerText = 'Masuk Aplikasi'; 
            }
        }

        function doLogout() {
            if(confirm('Yakin ingin keluar dari aplikasi?')) {
                currentUser = null; localStorage.removeItem('bpmp_user_session');
                switchPage('page-login'); document.getElementById('page-login').querySelector('form').reset();
            }
        }

        function processImage(input, index) {
            const file = input.files[0];
            if (!file) return;
            input.parentElement.classList.add('border-emerald-500', 'bg-emerald-50');
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const maxWidth = 800; 
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    uploadedImages[index] = { data: canvas.toDataURL('image/jpeg', 0.7).split(',')[1], mime: 'image/jpeg' };
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function submitLaporan(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-lap'); 
            const pCont = document.getElementById('progress-container'); 
            const pBar = document.getElementById('progress-bar');
            const pText = document.getElementById('progress-text');
            
            btn.disabled = true; 
            btn.innerHTML = `${isEditMode ? 'Mengupdate...' : 'Menyimpan...'}`;
            pCont.classList.remove('hidden'); pBar.style.width = "20%";

            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());
            payload.action = isEditMode ? 'update_laporan' : 'simpan_laporan';
            if(isEditMode) payload.target_judul = originalJudul;
            payload.user_input = currentUser.username;
            payload.images = uploadedImages;

            let pct = 20; const timer = setInterval(() => { if(pct<90) { pct+=5; pBar.style.width=pct+"%"; pText.innerText = pct+"%"; } }, 200);

            try {
                const res = await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                clearInterval(timer);
                if(data.status === 'success') {
                    pBar.style.width="100%"; pText.innerText = "100%";
                    showToast(isEditMode ? 'Laporan diperbarui!' : 'Laporan disimpan!', 'success');
                    setTimeout(() => { resetForm(); resetUI(); }, 1000);
                } else { showToast('Gagal: ' + data.message, 'error'); resetUI(); }
            } catch(err) { clearInterval(timer); showToast('Error Koneksi Internet', 'error'); resetUI(); }

            function resetUI() {
                pCont.classList.add('hidden'); isEditMode = false; originalJudul = "";
                btn.innerHTML = `Simpan Laporan`; 
                btn.classList.remove('from-yellow-500', 'to-yellow-600'); 
                btn.classList.add('from-blue-600', 'to-blue-700'); 
                btn.disabled = false;
            }
        }

        function resetForm() {
            if(confirm('Bersihkan semua isian formulir?')) {
                document.getElementById('form-laporan').reset();
                uploadedImages = [null, null, null, null];
                document.querySelectorAll('input[type="file"]').forEach(el => el.parentElement.classList.remove('border-emerald-500', 'bg-emerald-50'));
                const d = document.getElementById('input-date'); if(d) d.valueAsDate = new Date();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        async function loadLaporan() {
            switchPage('page-data');
            const tbody = document.getElementById('table-body');
            const loader = document.getElementById('loading-data');
            loader.classList.remove('hidden'); tbody.innerHTML = '';
            
            try {
                const res = await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_laporan' }) });
                const json = await res.json();
                if(json.status === 'success') {
                    const data = json.data.filter(item => (currentUser.role === 'admin' || currentUser.role === 'verifikator') ? true : item.user_input === currentUser.username);
                    if(data.length === 0) tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-400 italic bg-slate-50 rounded-xl m-4">Belum ada data laporan.</td></tr>';
                    else {
                        data.forEach(item => {
                            let btnEdit = '', btnHapus = '';
                            if (currentUser.role === 'admin' || item.user_input === currentUser.username) {
                                btnEdit = `<button onclick='editLaporan(${JSON.stringify(item)})' class="text-amber-500 hover:text-amber-700 font-bold px-3 py-1 bg-amber-50 hover:bg-amber-100 rounded-lg text-xs transition border border-amber-200">Edit</button>`;
                                btnHapus = `<button onclick='hapusLaporan("${item.judul_laporan}", "${item.user_input}")' class="ml-2 text-red-500 hover:text-red-700 font-bold px-3 py-1 bg-red-50 hover:bg-red-100 rounded-lg text-xs transition border border-red-200">Hapus</button>`;
                            }
                            let tgl = item.tanggal; try { tgl = new Date(item.tanggal).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}); } catch(e){}
                            
                            tbody.innerHTML += `
                                <tr class="hover:bg-blue-50/50 transition-colors border-b border-slate-50 last:border-0">
                                    <td class="p-5 font-medium text-slate-500">${tgl}</td>
                                    <td class="p-5 font-bold text-slate-800">${item.judul_laporan}</td>
                                    <td class="p-5">
                                        <div class="font-bold text-slate-700 text-xs uppercase">${item.nama_asn}</div>
                                        <div class="text-[10px] text-blue-500 bg-blue-50 inline-block px-1.5 rounded mt-1">${item.user_input}</div>
                                    </td>
                                    <td class="p-5 text-right">
                                        <button onclick='openPreview(${JSON.stringify(item)})' class="text-blue-600 hover:text-blue-800 font-bold px-3 py-1 bg-blue-50 hover:bg-blue-100 rounded-lg text-xs transition border border-blue-200 mr-1">Lihat</button>
                                        ${btnEdit}${btnHapus}
                                    </td>
                                </tr>`;
                        });
                    }
                }
            } catch(e) { showToast('Gagal memuat data', 'error'); } finally { loader.classList.add('hidden'); }
        }

        function editLaporan(data) {
            switchPage('page-input'); isEditMode = true; originalJudul = data.judul_laporan;
            const f = document.forms['form-laporan'];
            f['judul'].value = data.judul_laporan; f['pendahuluan'].value = data.pendahuluan; f['kegiatan'].value = data.kegiatan;
            f['hasil'].value = data.hasil; f['simpulan'].value = data.simpulan; f['saran'].value = data.saran;
            f['penutup'].value = data.penutup; f['tempat'].value = data.tempat; f['jabatan'].value = data.jabatan;
            f['nama_asn'].value = data.nama_asn; f['nip'].value = data.nip || '';
            f['ket1'].value = data.ket1 || ''; f['ket2'].value = data.ket2 || ''; f['ket3'].value = data.ket3 || ''; f['ket4'].value = data.ket4 || '';
            try { f['tanggal'].value = new Date(data.tanggal).toISOString().split('T')[0]; } catch(e){}
            
            const btn = document.getElementById('btn-submit-lap'); 
            btn.innerHTML = `Update Perubahan`; 
            btn.classList.remove('from-blue-600', 'to-blue-700'); 
            btn.classList.add('from-yellow-500', 'to-yellow-600');
            showToast('Mode Edit Aktif. Silakan ubah data.', 'info');
        }

        async function hapusLaporan(judul, user) {
            if(!confirm(`Yakin ingin menghapus laporan:\n"${judul}"?`)) return;
            try {
                await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'hapus_laporan', target_judul: judul, target_user: user }) });
                showToast('Data berhasil dihapus', 'success'); loadLaporan();
            } catch(e) { showToast('Gagal menghapus data', 'error'); }
        }

        async function loadUsers() {
            switchPage('page-users'); const tbody = document.getElementById('table-users'); 
            tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center"><div class="inline-block w-6 h-6 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"></div></td></tr>';
           // Ganti bagian try { ... } di dalam loadUsers dengan ini:
    try {
        const res = await fetch(CONST_WEB_APP_URL, { 
        method: 'POST', 
        // Tambahkan redirect: 'follow' untuk menangani redirection Google
        redirect: 'follow',
        // Memaksa tipe konten text/plain agar tidak memicu CORS pre-flight
        headers: {
            "Content-Type": "text/plain;charset=utf-8",
        },
        body: JSON.stringify({ action: 'get_users' }) 
        });
    
    const json = await res.json();
    // ... sisa kode tetap sama ...
                tbody.innerHTML = '';
                if(json.status === 'success') {
                    json.data.forEach(u => {
                        const isPermanent = u[0].toLowerCase() === 'admin';
                        const badgeColor = u[2] === 'admin' ? 'bg-purple-100 text-purple-700' : (u[2] === 'verifikator' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600');
                        const actionHtml = isPermanent ? '<span class="text-xs text-slate-400 font-bold bg-slate-100 px-2 py-1 rounded border border-slate-200">Permanen</span>' : 
                            `<div class="flex items-center gap-2"><select id="role-${u[0]}" class="bg-white border border-slate-200 text-xs rounded-lg px-2 py-1"><option value="user" ${u[2]=='user'?'selected':''}>User</option><option value="verifikator" ${u[2]=='verifikator'?'selected':''}>Verif</option><option value="admin" ${u[2]=='admin'?'selected':''}>Admin</option></select><button onclick="updateRole('${u[0]}')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1 rounded-lg text-xs font-bold transition">Simpan</button></div>`;
                        tbody.innerHTML += `<tr class="hover:bg-purple-50/50 transition-colors border-b border-slate-50 last:border-0"><td class="p-5 font-bold text-slate-700">${u[0]}</td><td class="p-5"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${badgeColor}">${u[2]}</span></td><td class="p-5 text-slate-500">${u[3]||'-'}</td><td class="p-5">${actionHtml}</td></tr>`;
                    });
                }
            } catch(e) { 
    console.error("Error Detail:", e); // Ini akan memunculkan error asli di Console (F12)
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-red-500 p-4">Gagal memuat data user. Cek Console (F12).</td></tr>'; 
}

        async function updateRole(user) {
            const newRole = document.getElementById(`role-${user}`).value;
            if(!confirm(`Ubah hak akses user "${user}" menjadi "${newRole}"?`)) return;
            try { await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'update_role', target_user: user, new_role: newRole }) }); showToast('Role diperbarui!', 'success'); loadUsers(); } catch(e) { showToast('Gagal update role', 'error'); }
        }

        async function addUser(e) {
            e.preventDefault(); if(!confirm('Tambahkan user baru ini?')) return;
            try {
                await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'add_user', new_user: document.getElementById('new-user').value, new_pass: document.getElementById('new-pass').value, new_role: document.getElementById('new-role').value, new_email: document.getElementById('new-email').value }) });
                showToast('User ditambahkan!', 'success'); loadUsers(); e.target.reset();
            } catch(e) { showToast('Gagal menambah user', 'error'); }
        }

        async function handleReset(e) {
            e.preventDefault(); const btn = document.getElementById('btn-reset'); btn.disabled = true; btn.innerText = "Mengecek Database...";
            try {
                const res = await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'lupa_password', target_user: document.getElementById('reset-user').value }) });
                const json = await res.json();
                if(json.status === 'success') { showToast('Sukses! Silakan cek email Anda.', 'success'); document.getElementById('modal-reset').classList.add('hidden'); } else { showToast(json.message, 'error'); }
            } catch(err) { showToast('Gagal koneksi server', 'error'); } finally { btn.disabled = false; btn.innerText = "Kirim Password Saya"; }
        }
        function showResetModal() { document.getElementById('modal-reset').classList.remove('hidden'); }

        function openPreview(data) {
            document.getElementById('p-judul').innerText = data.judul_laporan;
            document.getElementById('p-pendahuluan').innerText = data.pendahuluan;
            document.getElementById('p-kegiatan').innerText = data.kegiatan;
            document.getElementById('p-hasil').innerText = data.hasil;
            document.getElementById('p-simpulan').innerText = data.simpulan;
            document.getElementById('p-saran').innerText = data.saran;
            document.getElementById('p-penutup').innerText = data.penutup;
            document.getElementById('p-jabatan').innerText = data.jabatan;
            document.getElementById('p-nama').innerText = data.nama_asn;
            document.getElementById('p-nip').innerText = data.nip ? "NIP. "+data.nip : "";
            try { document.getElementById('p-tgl').innerText = (data.tempat||'Manokwari') + ', ' + new Date(data.tanggal).toLocaleDateString('id-ID', {day:'numeric',month:'long',year:'numeric'}); } catch(e){}
            
            const container = document.getElementById('doc-photos-container'); container.innerHTML = '';
            let photos = []; if(data.foto1) photos.push({u:data.foto1,k:data.ket1}); if(data.foto2) photos.push({u:data.foto2,k:data.ket2}); if(data.foto3) photos.push({u:data.foto3,k:data.ket3}); if(data.foto4) photos.push({u:data.foto4,k:data.ket4});
            
            const imgKop = document.getElementById('img-kop-preview');
            // imgKop.src = "data:image/png;base64,....."; 

            for(let i=0; i<photos.length; i+=2) {
                container.innerHTML += `<div class="a4-paper bg-white p-12 shadow-2xl mb-8 relative page-break min-h-[297mm]"><div class="text-center font-bold uppercase mb-8 border-b-2 border-slate-800 pb-2">Dokumentasi Kegiatan</div><div class="mb-10 text-center"><div class="inline-block border p-1 rounded bg-slate-50"><img src="${photos[i].u}" class="max-w-full h-auto max-h-[350px] object-contain"></div><div class="italic text-sm mt-2 font-serif">${photos[i].k||''}</div></div>` + (photos[i+1] ? `<div class="mt-10 pt-10 border-t border-dashed border-slate-300 text-center"><div class="inline-block border p-1 rounded bg-slate-50"><img src="${photos[i+1].u}" class="max-w-full h-auto max-h-[350px] object-contain"></div><div class="italic text-sm mt-2 font-serif">${photos[i+1].k||''}</div></div>` : '') + `</div>`;
            }
            document.getElementById('modal-preview').classList.remove('hidden');
        }

        window.onload = function() {
            const session = localStorage.getItem('bpmp_user_session');
            if(session) { currentUser = JSON.parse(session); switchPage('page-input'); } else { switchPage('page-login'); }
            const d = document.getElementById('input-date'); if(d) d.valueAsDate = new Date();
        };
    </script>
</body>
</html>



