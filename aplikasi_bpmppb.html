<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan BPMP Papua Barat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f3f4f6; }
        /* Glass Effect Modern */
        .glass { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.5); 
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }
        /* CSS HALAMAN */
        .app-page { display: none; }
        
        /* PRINT STYLE A4 */
       /* CSS KHUSUS CETAK (PERBAIKAN TOTAL MULTI-PAGE) */
        @media print {
            /* 1. Reset Body & HTML agar tidak membatasi tinggi kertas */
            html, body {
                height: auto !important;
                min-height: 100% !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* 2. Sembunyikan SEMUA elemen website (Login, Dashboard, dll) */
            body > * {
                display: none !important;
            }

            /* 3. Tampilkan HANYA Modal Preview */
            /* Kita gunakan selector ID yang spesifik */
            #modal-preview {
                display: block !important;
                visibility: visible !important;
                
                /* KUNCI PERBAIKAN: */
                position: absolute !important; 
                top: 0 !important;
                left: 0 !important;
                
                /* Paksa lebar & tinggi mengikuti konten, bukan layar */
                width: 100% !important;
                height: auto !important; 
                overflow: visible !important; /* Agar scrollbar hilang dan konten tumpah ke kertas */
                
                background: white !important;
                z-index: 9999 !important;
                margin: 0 !important;
            }

            /* 4. Pastikan isi modal juga terlihat */
            #modal-preview * {
                visibility: visible !important;
            }

            /* 5. Atur pemisahan halaman (Page Break) */
            .page-break {
                page-break-before: always !important; /* Paksa ganti halaman */
                break-before: page !important;
                display: block !important;
                margin-top: 2rem !important; /* Beri jarak sedikit di halaman baru */
                position: relative !important;
            }
            
            /* 6. Pastikan Kertas A4 tidak ada shadow/border saat diprint */
            .a4-paper {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            /* 7. Hilangkan tombol-tombol */
            .no-print {
                display: none !important;
            }
        }
        /* Style Foto di Preview */
        .photo-container { margin-top: 20px; }
        .photo-card { text-align: center; margin-bottom: 40px; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .photo-img { max-height: 90mm; max-width: 100%; object-fit: contain; margin: 0 auto; display: block; }
        .photo-caption { margin-top: 10px; font-style: italic; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-blue-200 selection:text-blue-900">

    <div id="toast" class="fixed top-6 right-6 hidden z-[100] transform transition-all duration-300 translate-y-[-20px] opacity-0">
        <div class="glass px-6 py-4 rounded-2xl shadow-2xl border-l-4 flex items-center gap-3 font-semibold text-sm">
            <span id="toast-msg">Notifikasi</span>
        </div>
    </div>

    <div id="page-login" class="app-page active">
        <div class="min-h-screen flex items-center justify-center bg-gradient-brand relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden opacity-20 pointer-events-none">
                <div class="absolute -top-[20%] -left-[10%] w-[600px] h-[600px] rounded-full bg-white blur-3xl"></div>
                <div class="absolute bottom-[10%] right-[10%] w-[400px] h-[400px] rounded-full bg-blue-400 blur-3xl"></div>
            </div>

            <div class="glass p-10 rounded-3xl shadow-2xl w-full max-w-md m-4 transform transition-all hover:scale-[1.01] duration-500 relative z-10">
                <div class="text-center mb-10">
                    <div class="inline-flex p-4 rounded-2xl bg-blue-50/50 mb-6 shadow-inner ring-1 ring-white/60">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg" alt="Logo Tut Wuri" class="w-16 h-16 object-contain drop-shadow-md">
                    </div>
                    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">E-Laporan</h1>
                    <p class="text-slate-500 text-sm mt-2 font-medium">BPMP Provinsi Papua Barat</p>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div class="group">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1 tracking-wide">Username</label>
                        <input type="text" id="login-user" placeholder="Masukkan username" class="w-full px-5 py-3.5 rounded-xl border border-slate-200 bg-white/70 focus:bg-white focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition duration-200 font-medium" required>
                    </div>
                    <div class="group">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1 tracking-wide">Password</label>
                        <input type="password" id="login-pass" placeholder="••••••••" class="w-full px-5 py-3.5 rounded-xl border border-slate-200 bg-white/70 focus:bg-white focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition duration-200 font-medium" required>
                    </div>
                    
                    <button type="submit" id="btn-login" class="w-full py-4 bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-800 hover:to-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transform active:scale-[0.98] transition-all duration-200 mt-2">
                        Masuk Aplikasi
                    </button>
                    
                    <div class="text-center mt-6">
                        <a href="#" onclick="showResetModal()" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition">Lupa Password?</a>
                    </div>
                </form>
                
                <div class="mt-8 pt-6 border-t border-slate-200/60 text-center">
                    <p class="text-xs text-slate-400 font-medium">&copy; 2026 BPMP Papua Barat</p>
                </div>
            </div>
        </div>
    </div>

    <nav id="navbar" class="hidden fixed top-0 w-full z-40 glass-nav transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 text-white p-2.5 rounded-xl shadow-lg shadow-blue-500/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <div class="leading-tight hidden sm:block">
                        <span class="block text-lg font-bold text-slate-800 tracking-tight">E-Laporan</span>
                        <span class="block text-[10px] text-slate-500 font-bold uppercase tracking-wider">BPMP Papua Barat</span>
                    </div>
                </div>

                <div class="hidden md:flex items-center gap-2 bg-slate-100/50 p-1.5 rounded-2xl border border-slate-200/60">
                    <button onclick="switchPage('page-input')" class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-blue-700 hover:bg-white hover:shadow-sm transition-all duration-200">
                        Input Data
                    </button>
                    <button id="menu-data" onclick="loadLaporan()" class="hidden px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-blue-700 hover:bg-white hover:shadow-sm transition-all duration-200">
                        Data Laporan
                    </button>
                    <button id="menu-user" onclick="loadUsers()" class="hidden px-5 py-2.5 rounded-xl text-sm font-bold text-slate-600 hover:text-purple-700 hover:bg-white hover:shadow-sm transition-all duration-200">
                        Kelola User
                    </button>
                </div>

                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div id="nav-username" class="text-sm font-bold text-slate-800">User</div>
                        <div id="nav-role" class="text-[10px] font-extrabold text-blue-600 uppercase bg-blue-50 px-2 py-0.5 rounded-full inline-block">Role</div>
                    </div>
                    <div class="h-8 w-[1px] bg-slate-200 hidden sm:block"></div>
                    <button onclick="doLogout()" class="group flex items-center gap-2 pl-3 pr-4 py-2 bg-white border border-slate-200 text-slate-600 hover:text-red-600 hover:border-red-100 hover:bg-red-50 rounded-xl transition-all duration-200 font-bold text-sm shadow-sm">
                        <svg class="w-4 h-4 text-slate-400 group-hover:text-red-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="h-24"></div>

    <div id="page-input" class="app-page max-w-5xl mx-auto px-4 pb-20">
        
        <div class="mb-8">
            <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Input Laporan</h2>
            <p class="text-slate-500 mt-1">Lengkapi data kegiatan di bawah ini.</p>
        </div>

        <form id="form-laporan" onsubmit="submitLaporan(event)" class="space-y-8">
            
            <div class="bg-white rounded-3xl p-8 shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-blue-600"></div>
                <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm">1</span>
                    Detail Kegiatan
                </h3>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">A. Judul Laporan</label>
                        <input type="text" name="judul" required class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none font-medium" placeholder="Judul Kegiatan...">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Tempat</label>
                            <input type="text" name="tempat" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none font-medium" required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Tanggal</label>
                            <input type="date" name="tanggal" id="input-date" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none font-medium" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-8 shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-purple-500"></div>
                <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <span class="bg-purple-100 text-purple-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm">2</span>
                    Isi Laporan
                </h3>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">B. Pendahuluan</label>
                        <textarea name="pendahuluan" rows="4" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Latar belakang..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">C. Kegiatan</label>
                        <textarea name="kegiatan" rows="4" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Rincian kegiatan..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">D. Hasil</label>
                        <textarea name="hasil" rows="4" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Hasil dicapai..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">E. Simpulan</label>
                            <textarea name="simpulan" rows="3" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Simpulan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Saran</label>
                            <textarea name="saran" rows="3" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Saran"></textarea>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">F. Penutup</label>
                        <textarea name="penutup" rows="2" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-purple-500 focus:ring-4 focus:ring-purple-500/10 transition-all outline-none" placeholder="Penutup..."></textarea>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white rounded-3xl p-8 shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-emerald-500"></div>
                    <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span class="bg-emerald-100 text-emerald-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm">3</span>
                        G. Lampiran Foto
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Foto 1</label>
                            <input type="file" accept="image/*" onchange="processImage(this, 0)" class="block w-full text-xs text-slate-500 mb-2">
                            <input type="text" name="ket1" placeholder="Keterangan..." class="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-emerald-500/20 outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Foto 2</label>
                            <input type="file" accept="image/*" onchange="processImage(this, 1)" class="block w-full text-xs text-slate-500 mb-2">
                            <input type="text" name="ket2" placeholder="Keterangan..." class="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-emerald-500/20 outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Foto 3</label>
                            <input type="file" accept="image/*" onchange="processImage(this, 2)" class="block w-full text-xs text-slate-500 mb-2">
                            <input type="text" name="ket3" placeholder="Keterangan..." class="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-emerald-500/20 outline-none">
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Foto 4</label>
                            <input type="file" accept="image/*" onchange="processImage(this, 3)" class="block w-full text-xs text-slate-500 mb-2">
                            <input type="text" name="ket4" placeholder="Keterangan..." class="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs focus:ring-2 focus:ring-emerald-500/20 outline-none">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-orange-500"></div>
                    <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span class="bg-orange-100 text-orange-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm">4</span>
                        Data Pelapor
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama ASN</label>
                            <input type="text" name="nama_asn" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all outline-none font-medium" placeholder="Nama Lengkap" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">NIP</label>
                            <input type="number" name="nip" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all outline-none font-medium" placeholder="NIP" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jabatan</label>
                            <input type="text" name="jabatan" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 transition-all outline-none font-medium" placeholder="Jabatan" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button type="submit" id="btn-submit-lap" class="flex-1 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold rounded-2xl shadow-xl shadow-blue-500/20 transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2 text-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    Simpan Laporan & Foto
                </button>
                <button type="button" onclick="resetForm()" class="px-8 py-4 bg-white text-slate-600 font-bold rounded-2xl shadow-lg border border-slate-100 hover:bg-slate-50 hover:text-red-600 transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Reset
                </button>
            </div>
            
            <div id="progress-container" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 glass px-6 py-4 rounded-full shadow-2xl z-50 border border-blue-100 flex items-center gap-4 w-[90%] max-w-md">
                <div class="flex-1">
                    <div class="flex justify-between mb-1 text-xs font-bold text-blue-700"><span>Mengirim Data...</span><span id="progress-text">0%</span></div>
                    <div class="w-full bg-blue-100 rounded-full h-2"><div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                </div>
            </div>
        </form>
    </div>

    <div id="page-data" class="app-page max-w-7xl mx-auto px-4 pb-20">
        <div class="mb-8"><h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Data Laporan Masuk</h2></div>
        
        <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50/80 border-b border-slate-200">
                            <th class="p-5 text-xs font-extrabold text-slate-500 uppercase tracking-wider">Tanggal</th>
                            <th class="p-5 text-xs font-extrabold text-slate-500 uppercase tracking-wider w-1/3">Judul</th>
                            <th class="p-5 text-xs font-extrabold text-slate-500 uppercase tracking-wider">Pembuat</th>
                            <th class="p-5 text-xs font-extrabold text-slate-500 uppercase tracking-wider text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
            <div id="loading-data" class="hidden p-12 text-center">
                <div class="inline-flex items-center justify-center p-4 bg-blue-50 rounded-full mb-3"><div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div></div>
                <p class="text-slate-500 font-medium">Sedang mengambil data...</p>
            </div>
        </div>
    </div>

    <div id="page-users" class="app-page max-w-5xl mx-auto px-4 pb-20">
        <div class="mb-8"><h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Kelola Pengguna</h2></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 sticky top-24">
                    <h3 class="font-bold text-slate-800 mb-4 pb-4 border-b border-slate-100">Tambah User Baru</h3>
                    <form onsubmit="addUser(event)" class="space-y-4">
                        <input type="text" id="new-user" placeholder="Username" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-purple-500 transition-all outline-none text-sm font-medium" required>
                        <input type="text" id="new-pass" placeholder="Password" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-purple-500 transition-all outline-none text-sm font-medium" required>
                        <select id="new-role" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-purple-500 transition-all outline-none text-sm font-medium">
                            <option value="user">User Biasa</option>
                            <option value="verifikator">Verifikator</option>
                            <option value="admin">Admin</option>
                        </select>
                        <input type="email" id="new-email" placeholder="Email Aktif" class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-purple-500 transition-all outline-none text-sm font-medium" required>
                        <button type="submit" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg transition-all text-sm flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> Tambah
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="lg:col-span-2">
                <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead><tr class="bg-purple-50/80 border-b border-purple-100"><th class="p-5 text-xs font-extrabold text-purple-800 uppercase">Username</th><th class="p-5 text-xs font-extrabold text-purple-800 uppercase">Role</th><th class="p-5 text-xs font-extrabold text-purple-800 uppercase">Email</th><th class="p-5 text-xs font-extrabold text-purple-800 uppercase">Aksi</th></tr></thead>
                        <tbody id="table-users" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-reset" class="fixed inset-0 bg-slate-900/60 hidden z-[100] flex items-center justify-center backdrop-blur-sm transition-all duration-300">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm m-4 relative">
            <button onclick="document.getElementById('modal-reset').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Reset Password</h3>
                <p class="text-sm text-slate-500 mt-2">Password akan dikirim ke email terdaftar.</p>
            </div>
            <form onsubmit="handleReset(event)" class="space-y-4">
                <input type="text" id="reset-user" class="w-full px-5 py-3 rounded-xl border border-slate-200 focus:border-blue-500 outline-none text-center font-bold" placeholder="Username Anda" required>
                <button type="submit" id="btn-reset" class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition">Kirim Password Saya</button>
            </form>
        </div>
    </div>

    <div id="modal-preview" class="fixed inset-0 bg-slate-900/80 hidden z-[9999] overflow-y-auto backdrop-blur-sm">
        <div class="min-h-screen py-10 flex justify-center px-4">
            <div class="relative w-full max-w-[210mm]">
                <div class="bg-slate-800 text-white p-4 rounded-xl flex justify-between items-center no-print sticky top-4 z-50 shadow-2xl mb-6">
                    <h3 class="font-bold text-sm md:text-base ml-2">Pratinjau Dokumen</h3>
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('modal-preview').classList.add('hidden')" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-sm transition">Tutup</button>
                        <button onclick="window.print()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 font-bold text-sm transition flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg> Cetak</button>
                    </div>
                </div>
                <div id="doc-container">
                    <div class="a4-paper bg-white p-12 shadow-2xl mb-8 relative min-h-[297mm]">
                        <div class="w-full mb-8 border-b-[3px] border-black pb-4 flex items-center gap-6">
                             <img src="" id="img-kop-preview" alt="Logo" class="w-24 h-24 object-contain">
                             <div class="text-center flex-1">
                                 <h2 class="text-lg font-bold uppercase tracking-wide">Kementerian Pendidikan, Kebudayaan,<br>Riset, dan Teknologi</h2>
                                 <h1 class="text-xl font-extrabold uppercase mt-1">Balai Penjaminan Mutu Pendidikan<br>Provinsi Papua Barat</h1>
                                 <p class="text-xs mt-2 italic font-serif">Alamat: Jl. Brigjend Marinir (Purn) Abraham O. Atururi, Arfai, Manokwari</p>
                             </div>
                        </div>
                        <div class="text-center mb-10">
                            <h2 class="font-bold text-xl uppercase underline decoration-2 underline-offset-4">LAPORAN KEGIATAN</h2>
                            <h3 id="p-judul" class="font-bold text-lg uppercase mt-4 px-8 leading-relaxed"></h3>
                        </div>
                        <div class="text-[11pt] text-black space-y-6 px-2 text-justify leading-relaxed font-serif">
                            <div><div class="font-bold uppercase mb-1">A. Pendahuluan</div><p id="p-pendahuluan" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">B. Pelaksanaan Kegiatan</div><p id="p-kegiatan" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">C. Hasil Kegiatan</div><p id="p-hasil" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">D. Simpulan</div><p id="p-simpulan" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">E. Saran / Rekomendasi</div><p id="p-saran" class="whitespace-pre-wrap ml-6"></p></div>
                            <div><div class="font-bold uppercase mb-1">F. Penutup</div><p id="p-penutup" class="whitespace-pre-wrap ml-6"></p></div>
                        </div>
                        <div class="mt-20 flex justify-end px-8">
                            <div class="text-center min-w-[250px] text-[11pt] text-black font-serif">
                                <p id="p-tgl" class="mb-1"></p>
                                <p id="p-jabatan" class="font-bold mb-24"></p>
                                <p id="p-nama" class="font-bold underline uppercase"></p>
                                <p id="p-nip" class="mt-1 font-medium"></p>
                            </div>
                        </div>
                    </div>
                    <div id="doc-photos-container"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // --- GANTI URL DI BAWAH INI ---
        const CONST_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwgedMQmPRbuvQKwZhvqU1kxz8hjxjpnMX4NzSOwFZF3AF4MFATX9mePfbUAd8SUzdOIQ/exec'; 

        // State
        let currentUser = null; 
        let uploadedImages = [null, null, null, null]; // Base64 Foto

        // --- 1. PROSES FOTO (RESIZE) ---
        function processImage(input, index) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; // Resize agar ringan
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    uploadedImages[index] = { data: dataUrl.split(',')[1], mime: 'image/jpeg' };
                    console.log(`Foto ${index+1} siap.`);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- 2. NAVIGASI ---
        function switchPage(pageId) {
            document.querySelectorAll('.app-page').forEach(page => page.style.display = 'none');
            const targetPage = document.getElementById(pageId);
            if (targetPage) { targetPage.style.display = 'block'; window.scrollTo(0,0); }
            updateNavbar();
        }

        function updateNavbar() {
            const nav = document.getElementById('navbar');
            if (currentUser) {
                nav.style.display = 'block';
                document.getElementById('nav-username').innerText = currentUser.username;
                document.getElementById('nav-role').innerText = currentUser.role;
                
                // --- PERBAIKAN DI SINI ---
                // Kita HAPUS logika pembatasan role.
                // Sekarang: Hapus class 'hidden' agar tombol muncul untuk SIAPA SAJA yang login.
                document.getElementById('menu-data').classList.remove('hidden');
                
                // Menu Kelola User tetap HANYA untuk ADMIN
                document.getElementById('menu-user').classList.toggle('hidden', currentUser.role !== 'admin');
            } else { 
                nav.style.display = 'none'; 
            }
        }

        // --- 3. LOGIN & LOGOUT ---
        async function handleLogin(e) {
            e.preventDefault(); const btn = document.getElementById('btn-login'); btn.innerText = 'Memuat...'; btn.disabled = true;
            try {
                const res = await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username: document.getElementById('login-user').value, password: document.getElementById('login-pass').value }) });
                const data = await res.json();
                if (data.status === 'success') {
                    currentUser = { username: data.username, role: data.role };
                    localStorage.setItem('bpmp_user_session', JSON.stringify(currentUser));
                    switchPage('page-input');
                } else { showToast(data.message, 'error'); }
            } catch (err) { showToast('Error Koneksi', 'error'); } finally { btn.innerText = 'Masuk Aplikasi'; btn.disabled = false; }
        }
        function doLogout() { if(confirm('Keluar?')) { localStorage.removeItem('bpmp_user_session'); currentUser = null; location.reload(); } }

        // --- 4. SUBMIT DENGAN FOTO ---
       // --- FUNGSI SUBMIT (DUAL MODE: SIMPAN & UPDATE) ---
        async function submitLaporan(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btn-submit-lap');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            btn.disabled = true;
            btn.innerText = isEditMode ? 'Mengupdate...' : 'Menyimpan...';
            progressContainer.classList.remove('hidden');
            updateBar(20, progressBar, progressText);

            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());
            
            // --- TENTUKAN ACTION ---
            if (isEditMode) {
                payload.action = 'update_laporan';
                payload.target_judul = originalJudul; // Kirim judul lama untuk dicari di sheet
            } else {
                payload.action = 'simpan_laporan';
            }
            
            payload.user_input = currentUser.username;
            payload.images = uploadedImages; // Foto baru (jika ada)

            // Animasi Progress
            let currentPercent = 20;
            const fakeProgress = setInterval(() => {
                if(currentPercent < 90) {
                    currentPercent += Math.floor(Math.random() * 5);
                    updateBar(currentPercent, progressBar, progressText);
                }
            }, 300);

            try {
                const res = await fetch(CONST_WEB_APP_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(payload) 
                });
                
                clearInterval(fakeProgress);
                const data = await res.json();

                if(data.status === 'success') {
                    updateBar(100, progressBar, progressText);
                    progressText.innerText = "Selesai!";
                    showToast(isEditMode ? 'Data Berhasil Diupdate!' : 'Data Berhasil Disimpan!', 'success');
                    
                    setTimeout(() => {
                        e.target.reset();
                        uploadedImages = [null, null, null, null];
                        document.getElementById('input-date').valueAsDate = new Date();
                        resetUI(); // Kembali ke tampilan awal
                    }, 1000);
                } else {
                    showToast('Gagal: ' + data.message, 'error');
                    resetUI();
                }

            } catch(err) { 
                clearInterval(fakeProgress);
                showToast('Gagal koneksi', 'error');
                resetUI();
            } 

            function updateBar(percent, bar, text) {
                bar.style.width = percent + "%";
                text.innerText = percent + "%";
            }

            function resetUI() {
                progressContainer.classList.add('hidden');
                updateBar(0, progressBar, progressText);
                
                // KEMBALIKAN TOMBOL KE MODE SIMPAN NORMAL
                isEditMode = false; 
                originalJudul = "";
                btn.classList.remove('from-yellow-500', 'to-yellow-600');
                btn.classList.add('from-blue-600', 'to-blue-700');
                btn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    Simpan Laporan & Foto
                `;
                btn.disabled = false;
            }
        }

        // --- 5. PREVIEW DENGAN HALAMAN FOTO OTOMATIS ---
        // --- FUNGSI PREVIEW YANG DIPERBAIKI ---
        function openPreview(data) {
            // 1. Masukkan Data Teks
            const setText = (id, val) => {
                const el = document.getElementById(id);
                if(el) el.innerText = val || '-';
            };

            setText('p-judul', data.judul_laporan || data.judul);
            setText('p-pendahuluan', data.pendahuluan);
            setText('p-kegiatan', data.kegiatan);
            setText('p-hasil', data.hasil);
            setText('p-simpulan', data.simpulan);
            setText('p-saran', data.saran);
            setText('p-penutup', data.penutup);

            // 2. Format Tanggal & Tanda Tangan
            let tglIndo = data.tanggal;
            try {
                tglIndo = new Date(data.tanggal).toLocaleDateString('id-ID', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
            } catch(e) {}
            
            setText('p-tgl', (data.tempat || 'Manokwari') + ', ' + tglIndo);
            setText('p-jabatan', data.jabatan || 'Pejabat Pelaksana');
            setText('p-nama', data.nama_asn);
            
            // Format NIP (Pakai logika jika ada isinya)
            const elNip = document.getElementById('p-nip');
            if(elNip) {
                elNip.innerText = data.nip ? "NIP. " + data.nip : "";
            }

            // 3. Generate Foto Dokumentasi
            const container = document.getElementById('doc-photos-container');
            container.innerHTML = ''; // Bersihkan foto lama
            
            let photos = [];
            if(data.foto1) photos.push({u:data.foto1, k:data.ket1});
            if(data.foto2) photos.push({u:data.foto2, k:data.ket2});
            if(data.foto3) photos.push({u:data.foto3, k:data.ket3});
            if(data.foto4) photos.push({u:data.foto4, k:data.ket4});

            // Loop Foto (2 foto per halaman)
            for(let i=0; i<photos.length; i+=2) {
                const page = document.createElement('div');
                // Class 'a4-paper' untuk layout kertas, 'page-break' untuk cetak
                page.className = 'a4-paper bg-white p-10 shadow-2xl mb-8 relative page-break';
                
                let html = `<div class="text-center font-bold text-lg border-b-2 border-black pb-4 mb-6 uppercase">
                                Lampiran Dokumentasi
                            </div>`;
                
                // Foto 1
                html += `<div class="mb-8 text-center">
                            <div class="inline-block border p-1 rounded">
                                <img src="${photos[i].u}" class="max-w-full h-auto max-h-[400px]">
                            </div>
                            <div class="italic text-sm mt-2">${photos[i].k || 'Dokumentasi 1'}</div>
                        </div>`;
                
                // Foto 2 (Jika ada)
                if(photos[i+1]) {
                    html += `<div class="mt-8 pt-8 border-t border-dashed border-gray-300 text-center">
                                <div class="inline-block border p-1 rounded">
                                    <img src="${photos[i+1].u}" class="max-w-full h-auto max-h-[400px]">
                                </div>
                                <div class="italic text-sm mt-2">${photos[i+1].k || 'Dokumentasi 2'}</div>
                            </div>`;
                }
                
                page.innerHTML = html;
                container.appendChild(page);
            }

            // Tampilkan Modal
            document.getElementById('modal-preview').classList.remove('hidden');
        }

       // --- LOAD DATA LAPORAN (DENGAN FILTER USER) ---
       // --- LOAD DATA LAPORAN (ADA TOMBOL EDIT) ---
       // --- LOAD DATA LAPORAN (UPDATE: TOMBOL HAPUS UNTUK SEMUA) ---
        async function loadLaporan() {
            switchPage('page-data');
            const loader = document.getElementById('loading-data');
            const tbody = document.getElementById('table-body');
            loader.classList.remove('hidden'); tbody.innerHTML = '';

            try {
                const res = await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_laporan' }) });
                const json = await res.json();
                
                if(json.status === 'success') {
                    // Filter Data (Admin/Verif lihat semua, User lihat punya sendiri)
                    const dataTampil = json.data.filter(item => {
                        if (currentUser.role === 'admin' || currentUser.role === 'verifikator') return true;
                        return item.user_input === currentUser.username;
                    });

                    if(dataTampil.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500 bg-gray-50 border border-dashed rounded italic">Belum ada data laporan.</td></tr>';
                    } else {
                        dataTampil.forEach(item => {
                            let tgl = item.tanggal;
                            try { tgl = new Date(item.tanggal).toLocaleDateString('id-ID'); } catch(e){}

                            // --- 1. TOMBOL EDIT (Kuning) ---
                            // Muncul untuk: Admin ATAU Pemilik Data
                            let btnEdit = '';
                            if (currentUser.role === 'admin' || item.user_input === currentUser.username) {
                                btnEdit = `
                                    <button onclick='editLaporan(${JSON.stringify(item)})' 
                                            class="ml-2 text-yellow-600 font-bold border border-yellow-200 bg-yellow-50 px-3 py-1 rounded hover:bg-yellow-500 hover:text-white transition text-xs">
                                        Edit
                                    </button>
                                `;
                            }

                            // --- 2. TOMBOL HAPUS (Merah) ---
                            // PERBAIKAN DI SINI:
                            // Muncul untuk: Admin ATAU Pemilik Data (Sama seperti Edit)
                            let btnHapus = '';
                            if (currentUser.role === 'admin' || item.user_input === currentUser.username) {
                                btnHapus = `
                                    <button onclick='hapusLaporan("${item.judul_laporan}", "${item.user_input}")' 
                                            class="ml-2 text-red-600 font-bold border border-red-200 bg-red-50 px-3 py-1 rounded hover:bg-red-600 hover:text-white transition text-xs">
                                        Hapus
                                    </button>
                                `;
                            }

                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-blue-50 border-b transition";
                            tr.innerHTML = `
                                <td class="p-4 text-sm text-gray-600">${tgl}</td>
                                <td class="p-4 font-bold text-gray-800">${item.judul_laporan || '-'}</td>
                                <td class="p-4 text-sm">
                                    <div class="font-bold text-gray-700">${item.nama_asn || '-'}</div>
                                    <div class="text-xs text-blue-500">Input: ${item.user_input}</div>
                                </td>
                                <td class="p-4 text-right">
                                    <button onclick='openPreview(${JSON.stringify(item)})' class="text-blue-600 font-bold border border-blue-600 px-3 py-1 rounded hover:bg-blue-600 hover:text-white transition text-xs">Lihat</button>
                                    ${btnEdit} 
                                    ${btnHapus}
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                }
            } catch(err) { console.error(err); showToast('Gagal memuat data', 'error'); } 
            finally { loader.classList.add('hidden'); }
        }

        // --- VARIABEL GLOBAL UNTUK EDIT MODE ---
        let isEditMode = false;
        let originalJudul = ""; // Kunci untuk mencari data lama

        // --- FUNGSI KLIK TOMBOL EDIT ---
        function editLaporan(data) {
            // 1. Masuk ke halaman input
            switchPage('page-input');
            
            // 2. Set Status Edit
            isEditMode = true;
            originalJudul = data.judul_laporan; // Simpan judul lama sebagai ID

            // 3. Ubah Teks Tombol & Judul Halaman
            const btnSubmit = document.getElementById('btn-submit-lap');
            btnSubmit.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Update Perubahan`;
            btnSubmit.classList.remove('from-blue-600', 'to-blue-700');
            btnSubmit.classList.add('from-yellow-500', 'to-yellow-600'); // Ubah warna jadi kuning/orange

            // 4. ISI FORMULIR DENGAN DATA LAMA
            const f = document.forms['form-laporan'];
            f['judul'].value = data.judul_laporan;
            f['pendahuluan'].value = data.pendahuluan;
            f['kegiatan'].value = data.kegiatan;
            f['hasil'].value = data.hasil;
            f['simpulan'].value = data.simpulan;
            f['saran'].value = data.saran;
            f['penutup'].value = data.penutup;
            f['tempat'].value = data.tempat;
            f['jabatan'].value = data.jabatan;
            f['nama_asn'].value = data.nama_asn;
            f['nip'].value = data.nip || '';

            // Format tanggal agar masuk ke input date
            try {
                const d = new Date(data.tanggal);
                f['tanggal'].value = d.toISOString().split('T')[0];
            } catch(e) {}
            
            // Isi Keterangan Foto
            f['ket1'].value = data.ket1 || '';
            f['ket2'].value = data.ket2 || '';
            f['ket3'].value = data.ket3 || '';
            f['ket4'].value = data.ket4 || '';

            // Scroll ke atas
            window.scrollTo(0,0);
            showToast('Mode Edit: Silakan ubah data.', 'success');
        }

        // --- FUNGSI HAPUS LAPORAN ---
       // --- FUNGSI HAPUS LAPORAN (UPDATE) ---
        async function hapusLaporan(judul, user) {
            // Tentukan Pesan Konfirmasi
            let pesan = `Anda yakin ingin menghapus laporan:\n"${judul}"?\n\nData tidak dapat dikembalikan!`;
            
            // Jika Admin menghapus punya orang lain, beri peringatan lebih keras
            if (currentUser.role === 'admin' && user !== currentUser.username) {
                pesan = `⚠️ PERINGATAN ADMIN ⚠️\n\nAnda akan menghapus data milik user: "${user}"\n\n${pesan}`;
            }

            if(!confirm(pesan)) return;

            showToast('Menghapus data...', 'info');
            
            try {
                const res = await fetch(CONST_WEB_APP_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'hapus_laporan', 
                        target_judul: judul,
                        target_user: user
                    }) 
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    showToast('Data BERHASIL Dihapus!', 'success');
                    loadLaporan(); // Refresh tabel
                } else {
                    showToast('Gagal: ' + data.message, 'error');
                }
            } catch(e) {
			
                showToast('Terjadi kesalahan koneksi', 'error');
            }
        }

        function showToast(msg, type='success') { const el = document.getElementById('toast'); el.className = `fixed top-5 right-5 z-50 px-6 py-4 rounded-xl shadow-2xl text-white font-bold ${type=='success'?'bg-green-600':'bg-red-600'}`; el.innerText = msg; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 3000); }
        // --- FUNGSI LOAD USER (DENGAN PROTEKSI ADMIN) ---
        // --- FUNGSI LOAD USERS (UPDATE: TAMPILKAN EMAIL) ---
       // --- FUNGSI LOAD DATA USER (DENGAN TOMBOL SIMPAN DI SAMPING) ---
        async function loadUsers() {
            switchPage('page-users');
            const tbody = document.getElementById('table-users');
            
            // Loading Spinner
            tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500 italic">Sedang memuat data...</td></tr>';
            
            try {
                const res = await fetch(CONST_WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_users' }) });
                const json = await res.json();
                
                tbody.innerHTML = ''; 
                
                if(json.status === 'success') {
                    json.data.forEach(u => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-blue-50 transition duration-150";
                        
                        const username = u[0];
                        const role = u[2];
                        const email = u[3] ? u[3] : '-';
                        
                        // ID UNIK UNTUK DROPDOWN (Penting!)
                        // Contoh: "role-select-budi", "role-select-siti"
                        const selectId = `role-select-${username}`;

                        // --- LOGIKA KOLOM AKSI ---
                        let actionHtml = '';
                        
                        if (username.toLowerCase() === 'admin') {
                            // Admin Utama: Terkunci
                            actionHtml = `
                                <div class="flex items-center gap-1 text-gray-400 bg-gray-100 px-3 py-1 rounded w-fit border border-gray-200">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    <span class="text-xs font-bold">Permanen</span>
                                </div>
                            `;
                        } else {
                            // User Biasa: Dropdown + Tombol Simpan
                            actionHtml = `
                                <div class="flex items-center gap-2">
                                    <select id="${selectId}" class="border border-gray-300 text-gray-700 text-sm rounded px-2 py-1 bg-white focus:ring-2 focus:ring-blue-200 outline-none w-32">
                                        <option value="user" ${role=='user'?'selected':''}>User Biasa</option>
                                        <option value="verifikator" ${role=='verifikator'?'selected':''}>Verifikator</option>
                                        <option value="admin" ${role=='admin'?'selected':''}>Admin</option>
                                    </select>

                                    <button onclick="updateRole('${username}')" 
                                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded flex items-center gap-1 shadow-sm transition transform active:scale-95"
                                            title="Simpan Perubahan Role">
                                        <span class="text-xs font-bold">Ubah</span>
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    </button>
                                </div>
                            `;
                        }

                        // Render Baris
                        tr.innerHTML = `
                            <td class="p-4 font-bold text-gray-700">${username}</td>
                            <td class="p-4">
                                <span class="px-2 py-1 rounded text-xs font-bold uppercase ${
                                    role==='admin' ? 'bg-purple-100 text-purple-700' : 
                                    (role==='verifikator' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600')
                                }">
                                    ${role}
                                </span>
                            </td>
                            <td class="p-4 text-sm text-gray-600">${email}</td>
                            <td class="p-4">
                                ${actionHtml}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch(e) { 
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Gagal memuat data.</td></tr>';
            }
        }

        // --- FUNGSI EKSEKUSI UBAH ROLE (DARI TOMBOL) ---
        async function updateRole(targetUser) {
            // 1. Ambil Nilai dari Dropdown berdasarkan ID Unik tadi
            const selectElement = document.getElementById(`role-select-${targetUser}`);
            const newRole = selectElement.value;

            // 2. Konfirmasi
            if(!confirm(`Simpan perubahan role "${targetUser}" menjadi "${newRole.toUpperCase()}"?`)) {
                return;
            }

            // 3. Proses Simpan
            showToast(`Menyimpan role ${targetUser}...`, 'info');

            try {
                const res = await fetch(CONST_WEB_APP_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'update_role', 
                        target_user: targetUser, 
                        new_role: newRole 
                    }) 
                });
                const json = await res.json();
                
                if (json.status === 'success') {
                    showToast('Sukses! Role berhasil diubah.', 'success');
                    loadUsers(); // Refresh tabel
                } else {
                    showToast('Gagal: ' + json.message, 'error');
                }
            } catch(e) {
                showToast('Kesalahan jaringan.', 'error');
            }
        }

        // --- FUNGSI TAMBAH USER (UPDATE: KIRIM EMAIL) ---
        async function addUser(e) {
            e.preventDefault();
            if(!confirm('Tambah user baru ini?')) return;
            
            const btn = e.target.querySelector('button');
            btn.innerText = 'Menyimpan...'; btn.disabled = true;

            try {
                await fetch(CONST_WEB_APP_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'add_user', 
                        new_user: document.getElementById('new-user').value,
                        new_pass: document.getElementById('new-pass').value,
                        new_role: document.getElementById('new-role').value,
                        new_email: document.getElementById('new-email').value // KIRIM EMAIL
                    }) 
                });
                showToast('User berhasil ditambahkan!', 'success');
                loadUsers(); // Refresh tabel
                e.target.reset(); // Bersihkan form
            } catch(e) { 
                showToast('Gagal menambah user', 'error'); 
            } finally {
                btn.innerText = '+ Tambah'; btn.disabled = false;
            }
        }

         // --- FITUR LUPA PASSWORD ---
        
        // 1. Tampilkan Modal
        function showResetModal() {
            document.getElementById('modal-reset').classList.remove('hidden');
            document.getElementById('reset-user').value = ''; // Kosongkan input
            document.getElementById('reset-user').focus();
        }

        // 2. Proses Kirim Permintaan
        async function handleReset(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btn-reset');
            const user = document.getElementById('reset-user').value;

            // Loading state
            btn.disabled = true;
            btn.innerText = "Mengecek Data...";
            
            try {
                const res = await fetch(CONST_WEB_APP_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'lupa_password', target_user: user }) 
                });
                const json = await res.json();
                
                if(json.status === 'success') {
                    showToast('Sukses! Cek Email Anda.', 'success');
                    document.getElementById('modal-reset').classList.add('hidden');
                } else {
                    showToast(json.message, 'error');
                }
            } catch(err) {
                showToast('Gagal koneksi server', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = "Kirim Password Saya";
            }
        }

        // --- FUNGSI RESET FORM ---
        function resetForm() {
            if(confirm('Apakah Anda yakin ingin menghapus semua isian dan foto?')) {
                // 1. Reset Form HTML (Text & File Inputs)
                document.getElementById('form-laporan').reset();
                
                // 2. Reset Variable Foto di Memory
                uploadedImages = [null, null, null, null]; 
                
                // 3. Kembalikan Tanggal ke Hari Ini
                const dateInput = document.getElementById('input-date');
                if(dateInput) dateInput.valueAsDate = new Date();
                
                console.log("Formulir dibersihkan.");
            }
        }

        window.onload = function() {
            const session = localStorage.getItem('bpmp_user_session');
            if(session) { currentUser = JSON.parse(session); switchPage('page-input'); } else { switchPage('page-login'); }
            const d = document.getElementById('input-date'); if(d) d.valueAsDate = new Date();
        };

       
    </script>
    
</body>

</html>


